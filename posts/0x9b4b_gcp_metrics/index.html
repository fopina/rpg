<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="0x9B4B Free Telemetry"><meta itemprop=description content="Some time ago I wrote about leveraging GCP free tier for log collection. I also started using it for telemetry though I never updated the post with those details.
Since Google refactored their Monitoring away from that crappy StackDriver interface, it&rsquo;s actually quite nice, so might as well write the setup down (up? ☁️).
Even though GCP monitoring seems oriented to metrics from GCP services it also allows you to create logs-based metrics."><meta itemprop=datePublished content="2020-11-24T02:54:26+00:00"><meta itemprop=dateModified content="2020-11-24T02:14:56+00:00"><meta itemprop=wordCount content="447"><meta itemprop=keywords content="gcp,logs,telemetry,cloud,fluentd,fluentbit,"><meta property="og:title" content="0x9B4B Free Telemetry"><meta property="og:description" content="Some time ago I wrote about leveraging GCP free tier for log collection. I also started using it for telemetry though I never updated the post with those details.
Since Google refactored their Monitoring away from that crappy StackDriver interface, it&rsquo;s actually quite nice, so might as well write the setup down (up? ☁️).
Even though GCP monitoring seems oriented to metrics from GCP services it also allows you to create logs-based metrics."><meta property="og:type" content="article"><meta property="og:url" content="https://rpg.skmobi.com/posts/0x9b4b_gcp_metrics/"><meta property="article:published_time" content="2020-11-24T02:54:26+00:00"><meta property="article:modified_time" content="2020-11-24T02:14:56+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0x9B4B Free Telemetry"><meta name=twitter:description content="Some time ago I wrote about leveraging GCP free tier for log collection. I also started using it for telemetry though I never updated the post with those details.
Since Google refactored their Monitoring away from that crappy StackDriver interface, it&rsquo;s actually quite nice, so might as well write the setup down (up? ☁️).
Even though GCP monitoring seems oriented to metrics from GCP services it also allows you to create logs-based metrics."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>0x9B4B Free Telemetry</title><link rel=stylesheet href=https://rpg.skmobi.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><link rel=stylesheet href=https://rpg.skmobi.com/css/foo.css></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://rpg.skmobi.com>Random Post Generator</a></div><nav class="site-nav hide-in-mobile"><a href=https://rpg.skmobi.com/posts/>Posts</a>
<a href=https://rpg.skmobi.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/skboy target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/fopina target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://rpg.skmobi.com/posts/>Posts</a></li><li><a href=https://rpg.skmobi.com/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Nov 24, 2020 - 3 min read</span></div><h1>0x9B4B Free Telemetry</h1></header><div class=content><p>Some time ago I <a href=/posts/0xd755_gcp_logging/>wrote</a> about leveraging GCP free tier for log collection. I also started using it for telemetry though I never updated the post with those details.</p><p>Since Google refactored their Monitoring away from that crappy StackDriver interface, it&rsquo;s actually quite nice, so might as well write the setup down (up? ☁️).</p><p>Even though GCP monitoring seems oriented to metrics from GCP services it also allows you to create <a href=https://cloud.google.com/logging/docs/logs-based-metrics/>logs-based metrics</a>.<br>This basically allows you to defined rules to extract data points from logs into metrics that can be monitored and alerted on.</p><p>First things first: based on <a href=/posts/0xd755_gcp_logging/>that previous post about GCP logging</a>, and assuming you have the setup mentioned there to ship logs to GCP/stackdriver, you can use <a href=https://fluentbit.io/>fluentbit</a> to generate these logs.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>~# /opt/td-agent-bit/bin/td-agent-bit -i mem -o stdout
Fluent Bit v1.5.6

<span class=o>[</span>2020/11/24 01:41:24<span class=o>]</span> <span class=o>[</span> info<span class=o>]</span> <span class=o>[</span>engine<span class=o>]</span> started <span class=o>(</span><span class=nv>pid</span><span class=o>=</span>21309<span class=o>)</span>
<span class=o>[</span>2020/11/24 01:41:24<span class=o>]</span> <span class=o>[</span> info<span class=o>]</span> <span class=o>[</span>storage<span class=o>]</span> <span class=nv>version</span><span class=o>=</span>1.0.5, initializing...
<span class=o>[</span>2020/11/24 01:41:24<span class=o>]</span> <span class=o>[</span> info<span class=o>]</span> <span class=o>[</span>storage<span class=o>]</span> in-memory
<span class=o>[</span>2020/11/24 01:41:24<span class=o>]</span> <span class=o>[</span> info<span class=o>]</span> <span class=o>[</span>storage<span class=o>]</span> normal synchronization mode, checksum disabled, <span class=nv>max_chunks_up</span><span class=o>=</span><span class=m>128</span>
<span class=o>[</span>2020/11/24 01:41:24<span class=o>]</span> <span class=o>[</span> info<span class=o>]</span> <span class=o>[</span>sp<span class=o>]</span> stream processor started
<span class=o>[</span>0<span class=o>]</span> mem.0: <span class=o>[</span>1606182084.325065322, <span class=o>{</span><span class=s2>&#34;Mem.total&#34;</span><span class=o>=</span>&gt;948084, <span class=s2>&#34;Mem.used&#34;</span><span class=o>=</span>&gt;772048, <span class=s2>&#34;Mem.free&#34;</span><span class=o>=</span>&gt;176036, <span class=s2>&#34;Swap.total&#34;</span><span class=o>=</span>&gt;102396, <span class=s2>&#34;Swap.used&#34;</span><span class=o>=</span>&gt;6608, <span class=s2>&#34;Swap.free&#34;</span><span class=o>=</span>&gt;95788<span class=o>}]</span>
<span class=o>[</span>1<span class=o>]</span> mem.0: <span class=o>[</span>1606182085.325055771, <span class=o>{</span><span class=s2>&#34;Mem.total&#34;</span><span class=o>=</span>&gt;948084, <span class=s2>&#34;Mem.used&#34;</span><span class=o>=</span>&gt;772088, <span class=s2>&#34;Mem.free&#34;</span><span class=o>=</span>&gt;175996, <span class=s2>&#34;Swap.total&#34;</span><span class=o>=</span>&gt;102396, <span class=s2>&#34;Swap.used&#34;</span><span class=o>=</span>&gt;6608, <span class=s2>&#34;Swap.free&#34;</span><span class=o>=</span>&gt;95788<span class=o>}]</span>
<span class=o>[</span>2<span class=o>]</span> mem.0: <span class=o>[</span>1606182086.325105700, <span class=o>{</span><span class=s2>&#34;Mem.total&#34;</span><span class=o>=</span>&gt;948084, <span class=s2>&#34;Mem.used&#34;</span><span class=o>=</span>&gt;772904, <span class=s2>&#34;Mem.free&#34;</span><span class=o>=</span>&gt;175180, <span class=s2>&#34;Swap.total&#34;</span><span class=o>=</span>&gt;102396, <span class=s2>&#34;Swap.used&#34;</span><span class=o>=</span>&gt;6608, <span class=s2>&#34;Swap.free&#34;</span><span class=o>=</span>&gt;95788<span class=o>}]</span>
</code></pre></div><p>configuration file <code>/etc/td-agent-bit/td-agent-bit.conf</code> would be updated with something like:</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=na>...</span>

<span class=k>[INPUT]</span>
    <span class=na>Name cpu</span>
    <span class=na>Tag cpu</span>
    <span class=na>Interval_Sec 10</span>

<span class=k>[INPUT]</span>
    <span class=na>Name mem</span>
    <span class=na>Tag mem</span>
    <span class=na>Interval_Sec 10</span>

<span class=na>...</span>

<span class=k>[OUTPUT]</span>
    <span class=na>Name stackdriver</span>
    <span class=na>google_service_credentials /etc/gcreds.json</span>
    <span class=na>Match *</span>
</code></pre></div><p>Logs will then show up in GCP Logs Viewer:</p><a href=/posts/0x9b4b_gcp_metrics/shot1.png><img src=/posts/0x9b4b_gcp_metrics/shot1_hu74071fae66812d2454692a91eaf0d9b6_107407_600x0_resize_box_2.png width=600 height=119></a><p>As an extra step, as fluentbit <code>mem</code> outputs bytes, GCP does not allow any transformation of the data and visualization with multiple hostnames is friendlier when using percentage (instead of absolute values), I&rsquo;ve created <a href=https://github.com/fopina/fluent-bit-filter-math>a fluenbit math filter</a>.</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=na>...</span>
<span class=k>[INPUT]</span>
    <span class=na>Name mem</span>
    <span class=na>Tag mem</span>
    <span class=na>Interval_Sec 10</span>

<span class=k>[FILTER]</span>
    <span class=na>Name math</span>
    <span class=na>Match mem</span>
    <span class=na>Operation div</span>
    <span class=na>Field Mem.used</span>
    <span class=na>Field Mem.total</span>
    <span class=na>Output_field Mem.usage</span>
<span class=na>...</span>
</code></pre></div><p>This <code>[FILTER]</code> entry will add <code>Mem.usage</code> to the output (which is <code>Mem.used / Mem.total</code>).</p><p>In the <code>Logs Viewer</code> you can then click <code>Actions</code>, <code>Create Metric</code> and set it up.</p><a href=/posts/0x9b4b_gcp_metrics/shot2.png><img src=/posts/0x9b4b_gcp_metrics/shot2_hud475d487dd79bc8f34550ec4e3280d1a_347900_600x0_resize_box_2.png width=600 height=252></a><p>Type <code>counter</code> will just measure the number of log lines for the given query while <code>distribution</code> will extract an actual value from each line (distribution being the right choice here).</p><p>Metric setup, it can now be added to a dashboard and/or used as alert source</p><a href=/posts/0x9b4b_gcp_metrics/shot3.png><img src=/posts/0x9b4b_gcp_metrics/shot3_hucdb481de5eb74ed37e831e5a9b7d20d0_374560_600x0_resize_box_2.png width=600 height=320></a><h3 id=note>Note<a href=#note class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>These metrics will count both towards logs and metric ingestion limits. At the moment they are respectively 10GB and 150MB (per month).</p><p>I have some exclusion filters on the logs (for frequent lines that noone cares). About 10 hosts shipping logs to this (about 30 docker services) and still hardly go above 3GB used for logs.<br>Metric ingestion does get to 150MB quickly if we start adding a few&mldr;</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rpg.skmobi.com/tags/gcp>gcp</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/logs>logs</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/telemetry>telemetry</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/cloud>cloud</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/fluentd>fluentd</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/fluentbit>fluentbit</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>447 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2020-11-24 02:54 +0000</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/fopina/rpg/commit/b66ee56e2ce945becf6cac281ee342b779b9a2bd target=_blank rel=noopener>b66ee56</a> @ 2020-11-24</p></footer></article><div class="post-nav thin"><a class=next-post href=https://rpg.skmobi.com/posts/0xf404_mini_delta/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>0xF404 Mono Price, Mini Print</span></a>
<a class=prev-post href=https://rpg.skmobi.com/posts/0xcf53_rgr/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>0xCF53 Remote, Garage Remote</span></a></div><div id=comments class=thin><script src=https://utteranc.es/client.js repo=fopina/rpg issue-term=title theme=github-light crossorigin=anonymous label=comment async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2020 <a href=https://rpg.skmobi.com>Filipe Pina</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://rpg.skmobi.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://rpg.skmobi.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-152680315-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>