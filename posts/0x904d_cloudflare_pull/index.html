<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="0x904Drop IPTables Drop"><meta itemprop=description content="My houselab is made of a few RPis and docker swarm.
Traefik is used to expose (most of) the swarm services and some of these services are exposed to the internet.
Traefik docker-compose includes these flags
- --entrypoints.http.address=:80- --entrypoints.https.address=:443- --entrypoints.https_external.address=:8443Home router has port forwarding from 443 to 8443 on one of the manager nodes (where Traefik runs). Binding services to http (80) or https (443) exposes them internally only, binding to https_external (8443) exposes them to the internet."><meta itemprop=datePublished content="2021-04-09T01:37:29+01:00"><meta itemprop=dateModified content="2021-04-09T03:12:09+01:00"><meta itemprop=wordCount content="654"><meta itemprop=keywords content="cloudflare,traefik,iptables,mtls,"><meta property="og:title" content="0x904Drop IPTables Drop"><meta property="og:description" content="My houselab is made of a few RPis and docker swarm.
Traefik is used to expose (most of) the swarm services and some of these services are exposed to the internet.
Traefik docker-compose includes these flags
- --entrypoints.http.address=:80- --entrypoints.https.address=:443- --entrypoints.https_external.address=:8443Home router has port forwarding from 443 to 8443 on one of the manager nodes (where Traefik runs). Binding services to http (80) or https (443) exposes them internally only, binding to https_external (8443) exposes them to the internet."><meta property="og:type" content="article"><meta property="og:url" content="https://rpg.skmobi.com/posts/0x904d_cloudflare_pull/"><meta property="article:published_time" content="2021-04-09T01:37:29+01:00"><meta property="article:modified_time" content="2021-04-09T03:12:09+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0x904Drop IPTables Drop"><meta name=twitter:description content="My houselab is made of a few RPis and docker swarm.
Traefik is used to expose (most of) the swarm services and some of these services are exposed to the internet.
Traefik docker-compose includes these flags
- --entrypoints.http.address=:80- --entrypoints.https.address=:443- --entrypoints.https_external.address=:8443Home router has port forwarding from 443 to 8443 on one of the manager nodes (where Traefik runs). Binding services to http (80) or https (443) exposes them internally only, binding to https_external (8443) exposes them to the internet."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>0x904Drop IPTables Drop</title><link rel=stylesheet href=https://rpg.skmobi.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><link rel=stylesheet href=https://rpg.skmobi.com/css/foo.css></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://rpg.skmobi.com>Random Post Generator</a></div><nav class="site-nav hide-in-mobile"><a href=https://rpg.skmobi.com/posts/>Posts</a>
<a href=https://rpg.skmobi.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/skboy target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/fopina target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://rpg.skmobi.com/posts/>Posts</a></li><li><a href=https://rpg.skmobi.com/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Apr 9, 2021 - 4 min read</span></div><h1>0x904Drop IPTables Drop</h1></header><div class=content><p>My houselab is made of a few RPis and docker swarm.<br>Traefik is used to expose (most of) the swarm services and some of these services are exposed to the internet.</p><p>Traefik docker-compose includes these flags</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w> </span>- --<span class=l>entrypoints.http.address=:80</span><span class=w>
</span><span class=w> </span>- --<span class=l>entrypoints.https.address=:443</span><span class=w>
</span><span class=w> </span>- --<span class=l>entrypoints.https_external.address=:8443</span><span class=w>
</span></code></pre></div><p>Home router has port forwarding from 443 to 8443 on one of the manager nodes (where Traefik runs). Binding services to <code>http</code> (80) or <code>https</code> (443) exposes them internally only, binding to <code>https_external</code> (8443) exposes them to the internet.</p><p>With this, service exposure is managed in the service docker-compose itself</p><p>Internal-only</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.enable</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.docker.network</span><span class=p>:</span><span class=w> </span><span class=l>traefik_default</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.services.myweb.loadbalancer.server.port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.routers.myweb.rule</span><span class=p>:</span><span class=w> </span><span class=l>Host(`myweb.internal`)</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.routers.myweb.entrypoints</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.routers.myweb.middlewares</span><span class=p>:</span><span class=w> </span><span class=l>https-only</span><span class=w>
</span></code></pre></div><p>Or the extra labels to make it external</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=nt>traefik.http.routers.myweb_ext.rule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Host(`myweb.skmobi.com`)&#34;</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.routers.myweb_ext.entrypoints</span><span class=p>:</span><span class=w> </span><span class=l>https_external</span><span class=w>
</span></code></pre></div><p>To have some sort of extra security üîí, all of these domain are behind ‚òÅÔ∏è Cloudflare.<br>In order to prevent anyone from bypassing it, I was using a simple <a href=https://github.com/fopina/ansible-roles/tree/main/cloudflare-ips>ansible role</a> in my RPi provisioning playbook to make sure the <a href=https://www.cloudflare.com/ips/>latest IP ranges from $NET</a> were set up in iptables.</p><p>When I read about their <a href=https://support.cloudflare.com/hc/en-us/articles/204899617>Authenticated Origin Pulls</a> I immediately added it to my backlog, as it&rsquo;s much cleaner to install a CA once than managing IP ranges in iptables.</p><p>And it would allow me to also have non-proxied services in the same port (based on SNI), even restrict those to my own client certificates (issued by the <a href=/posts/0x6fd7_docker_internal_ca/>same internal CA I use for server certificates</a>)</p><p>And it&rsquo;s safer as <a href=https://jychp.medium.com/how-to-bypass-cloudflare-bot-protection-1f2c6c0c36fb>IP ACLs are not that reliable</a>.</p><p>And probably overall performance is even better (<em>checking rules on every packet versus extra validation on TLS negotiation only</em>) - <strong>to be tested</strong> üîú</p><p>I left that <a href=https://help.trello.com/article/820-card-aging>Trello card age</a> for some time like a good wine and finally picked it up!</p><p>One quick option would be to spin up an <code>nginx</code> container, set it up as cloudflare <a href=https://support.cloudflare.com/hc/en-us/articles/204899617#h_2WFdI4xHJSAQ6GqBjgkfhb>documented</a>, <code>proxypass</code> all of it to traefik and change the port forward to nginx port instead.<br>But that would require all services behind cloudflare instead of letting me choose per service. Plus, it&rsquo;d be yet another piece in the stack.</p><p>So let&rsquo;s get traefik to handle it!</p><p>Traefik has this <a href=https://doc.traefik.io/traefik/routing/routers/#options>tls.options</a> available both at entrypoint level and router level. But sadly, it&rsquo;s not possible to configure each parameter with labels (<a href=https://github.com/traefik/traefik/issues/5507>yet</a>).</p><p>Enter dynamic configuration! Create some file somewhere, such as <code>/etc/traefik/dynamic/tlsoptions.yaml</code>, with</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>tls</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>options</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>cfcert</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>clientAuth</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>caFiles</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=l>/etc/traefik/dynamic/origin-pull-ca.pem</span><span class=w>
</span><span class=w>        </span><span class=nt>clientAuthType</span><span class=p>:</span><span class=w> </span><span class=l>RequireAndVerifyClientCert</span><span class=w>
</span></code></pre></div><p>Place the <a href=https://support.cloudflare.com/hc/en-us/article_attachments/360044928032/origin-pull-ca.pem>cloudflare-provided origin-pull-ca.pem</a> and add this conf to traefik (CLI flag)</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml>- --<span class=l>providers.file.directory=/etc/traefik/dynamic</span><span class=w>
</span></code></pre></div><p>Now, if some service should be only accessible through cloudflare, I only need to add one extra label, with the new <code>tls.options</code> <code>cfcert</code>:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>      </span><span class=nt>traefik.http.routers.myweb_ext.entrypoints</span><span class=p>:</span><span class=w> </span><span class=l>https_external</span><span class=w>
</span><span class=w>      </span><span class=nt>traefik.http.routers.myweb_ext.tls.options</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;cfcert@file&#34;</span><span class=w>
</span></code></pre></div><p>As most of my exposed services <em>should</em> be behind cloudflare, I decided to apply this directly to the entrypoint (traefik CLI flag)</p><pre><code>      - --entrypoints.https_external.http.tls.options=cfcert@file
</code></pre><p>This makes it the default <code>tls.option</code> for any service on entrypoint <code>https_external</code> üëç<br>And to disable it, just need to apply label <code>traefik.http.routers.myweb_ext.tls.options: "default"</code> to a service.</p><p><em>NOTE</em></p><p><em>For some reason a label such as <code>traefik.http.routers.myweb_ext.tls: "true"</code> resets everything in <code>tls</code> back to default. Remove it if you don&rsquo;t need (it should be implicit anyway). If you do need, just re-define <code>tls.options</code> as well.</em></p><p>Unfortunately, setting the <code>tls.option</code> at entrypoint level still does not apply to the default router (the 404 shown when no service matches), and I&rsquo;d really like to have traefik just TLS-reset all those botscan connections&mldr;</p><p>I tried modifying <code>default</code> <code>tls.options</code> (instead of naming it <code>cfcert</code>) but then it applied to every entrypoint, including the internal ones (which hopefully are never pinged by cloudflare!).</p><p>Also found <a href=https://www.techjunktrunk.com/docker/2017/11/03/traefik-default-server-catch-all/>this</a> to setup a new default service. It seems to work as advertised, matching any request that was not caught by others, but:</p><pre><code>traefik_traefik.1.lqdaryaciaex@sfpi3    | time=&quot;2021-04-09T00:02:07Z&quot; level=warning msg=&quot;No domain found in rule HostRegexp(`{catchall:.*}`), the TLS options applied for this router will depend on the hostSNI of each request&quot; entryPointName=https_external routerName=myweb_ext@docker
</code></pre><p>So traefik only binds tls.options based on the configured SNI, not in the SNI requested&mldr;</p><p>Too bad, but still happy overall with the final setup!</p><p>Fun part: I finally did this last week and today cloudflare announced <a href=https://www.cloudflare.com/ips/>IP changes</a>. But no, I don&rsquo;t have to do anything about it (anymore).</p></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rpg.skmobi.com/tags/cloudflare>cloudflare</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/traefik>traefik</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/iptables>iptables</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/mtls>mtls</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>654 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-04-09 00:37 +0000</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/fopina/rpg/commit/cbf10a57693d7f6440d5b885c76233b6de197288 target=_blank rel=noopener>cbf10a5</a> @ 2021-04-09</p></footer></article><div class="post-nav thin"><a class=prev-post href=https://rpg.skmobi.com/posts/0x474e_telegraf/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>0x474E (In)fluent(a)bit</span></a></div><div id=comments class=thin><script src=https://utteranc.es/client.js repo=fopina/rpg issue-term=title theme=github-light crossorigin=anonymous label=comment async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://rpg.skmobi.com>Filipe Pina</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://rpg.skmobi.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://rpg.skmobi.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-152680315-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>