<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="0xB752 ddwrt + custom certificate"><meta itemprop=description content="When I first installed dd-wrt (no support from openwrt) on my router, I enabled HTTPS-only access for the web UI.
When the nasty prompt from the self-signed certificate popped up, I looked for an option to upload my own cerficate (signed by the internal CA I use).
There was none&mldr;
Left it be for quite soem time, but finally decided to sort it out and, to my surprise, there&rsquo;s no official documentation on it (or not easy to find, at least)&mldr;"><meta itemprop=datePublished content="2021-02-14T16:26:09+00:00"><meta itemprop=dateModified content="2021-02-14T17:35:16+00:00"><meta itemprop=wordCount content="489"><meta itemprop=keywords content="ddwrt,router,ssl,certificates,"><meta property="og:title" content="0xB752 ddwrt + custom certificate"><meta property="og:description" content="When I first installed dd-wrt (no support from openwrt) on my router, I enabled HTTPS-only access for the web UI.
When the nasty prompt from the self-signed certificate popped up, I looked for an option to upload my own cerficate (signed by the internal CA I use).
There was none&mldr;
Left it be for quite soem time, but finally decided to sort it out and, to my surprise, there&rsquo;s no official documentation on it (or not easy to find, at least)&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://rpg.skmobi.com/posts/0xb752_ddwrt_ssl/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-14T16:26:09+00:00"><meta property="article:modified_time" content="2021-02-14T17:35:16+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0xB752 ddwrt + custom certificate"><meta name=twitter:description content="When I first installed dd-wrt (no support from openwrt) on my router, I enabled HTTPS-only access for the web UI.
When the nasty prompt from the self-signed certificate popped up, I looked for an option to upload my own cerficate (signed by the internal CA I use).
There was none&mldr;
Left it be for quite soem time, but finally decided to sort it out and, to my surprise, there&rsquo;s no official documentation on it (or not easy to find, at least)&mldr;"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>0xB752 ddwrt + custom certificate</title><link rel=stylesheet href=https://rpg.skmobi.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><link rel=stylesheet href=https://rpg.skmobi.com/css/foo.css></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://rpg.skmobi.com>Random Post Generator</a></div><nav class="site-nav hide-in-mobile"><a href=https://rpg.skmobi.com/posts/>Posts</a>
<a href=https://rpg.skmobi.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/skboy target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/fopina target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://rpg.skmobi.com/posts/>Posts</a></li><li><a href=https://rpg.skmobi.com/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Feb 14, 2021 - 3 min read</span></div><h1>0xB752 ddwrt + custom certificate</h1></header><div class=content><p>When I first installed <a href=https://dd-wrt.com/>dd-wrt</a> (no support from <a href=https://openwrt.org/>openwrt</a>) on <a href=https://www.netgear.com/home/online-gaming/routers/xr500/>my router</a>, I enabled HTTPS-only access for the web UI.<br>When the nasty prompt from the self-signed certificate popped up, I looked for an option to upload my own cerficate (signed by the internal CA I use).<br>There was none&mldr;</p><p>Left it be for quite soem time, but finally decided to sort it out and, to my surprise, there&rsquo;s no official documentation on it (or not easy to find, at least)&mldr;</p><p>Found <a href="https://forum.dd-wrt.com/phpBB2/viewtopic.php?t=27979">this thread</a> on their forum which basically set two options:</p><ul><li>using <a href=https://forum.dd-wrt.com/wiki/index.php/Development#Firmware_Modification_Kit>firmware mod kit</a> to embed your cert into the image before flashing (no need to recompile at least&mldr;)</li><li>enable JFFS, save the cert (and key) there and use a startup script to <code>mount -o bind</code> those on the default <code>/etc/cert.pem</code> and <code>/etc/key.pem</code> locations</li></ul><p>I found it hard to believe that dd-wrt had no GUI setting for a custom SSL cert, even more that there wouldn&rsquo;t be some <code>nvram</code> setting to store one, at least using ssh&mldr;</p><p>Both options would be ok, but I decided to take a quick look at dd-wrt code and found <a href=https://github.com/mirror/dd-wrt/blob/088ba261dfe84e43e5954dd66e9ced02c01a1a95/src/router/httpd/httpd.c#L1564-L1583>this</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#if defined(HAVE_OPENSSL) || defined(HAVE_MATRIXSSL) || defined(HAVE_POLARSSL)
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=kt>char</span> <span class=o>*</span><span class=n>cert</span> <span class=o>=</span> <span class=n>nvram_safe_get</span><span class=p>(</span><span class=s>&#34;https_cert&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=o>*</span><span class=n>key</span> <span class=o>=</span> <span class=n>nvram_safe_get</span><span class=p>(</span><span class=s>&#34;https_key&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=o>*</span><span class=n>certfile</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=kt>char</span> <span class=o>*</span><span class=n>keyfile</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>cert</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>certfile</span> <span class=o>=</span> <span class=s>&#34;/tmp/https_cert&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>writenvram</span><span class=p>(</span><span class=s>&#34;https_cert&#34;</span><span class=p>,</span> <span class=n>certfile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>key</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=n>keyfile</span> <span class=o>=</span> <span class=s>&#34;/tmp/https_key&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>writenvram</span><span class=p>(</span><span class=s>&#34;https_key&#34;</span><span class=p>,</span> <span class=n>keyfile</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>certfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>certfile</span> <span class=o>=</span> <span class=n>nvram_safe_get</span><span class=p>(</span><span class=s>&#34;https_cert_file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!*</span><span class=n>certfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>certfile</span> <span class=o>=</span> <span class=n>CERT_FILE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>keyfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>keyfile</span> <span class=o>=</span> <span class=n>nvram_safe_get</span><span class=p>(</span><span class=s>&#34;https_key_file&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=o>!*</span><span class=n>keyfile</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=n>keyfile</span> <span class=o>=</span> <span class=n>KEY_FILE</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><p>Taking a look at blame it points to <a href=https://github.com/mirror/dd-wrt/commit/e27ffb50f592a58a392c789a24e2e681eb298112>rev 44703</a>, so sort of recent.</p><p>It seems before it already supported specifying a custom location but only if was compiled with <code>HAVE_CUSTOMSSLCERT</code> 🤷</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifdef HAVE_CUSTOMSSLCERT
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=k>if</span> <span class=p>(</span><span class=n>SSL_CTX_use_certificate_file</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>certfile</span><span class=p>,</span> <span class=n>SSL_FILETYPE_PEM</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>SSL_CTX_use_certificate_file</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>nvram_safe_get</span><span class=p>(</span><span class=s>&#34;https_cert_file&#34;</span><span class=p>),</span> <span class=n>SSL_FILETYPE_PEM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=k>if</span> <span class=p>(</span><span class=n>SSL_CTX_use_certificate_file</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>CERT_FILE</span><span class=p>,</span> <span class=n>SSL_FILETYPE_PEM</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><p>Anyway, I haven&rsquo;t found these new nvram settings documented anywhere, so I&rsquo;ll highlight them here:</p><ul><li><code>https_cert</code> / <code>https_key</code> - set them to the raw content of a cert / key and done, no need to store them anywhere in the router filesystem (so it does not require JFFS enabled)</li><li><code>https_cert_file</code> / <code>https_key_file</code> - set them to the paths to each respective file, so you&rsquo;ll have to enable JFFS (or embed in the image, though that wouldn&rsquo;t make much sense - just overwrite the default one). I assume this might be helpful if <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> (or any other form of short-lived certs) are used and it&rsquo;s easier to replace a file that push to <code>nvram</code>. Or maybe if a very long chain of trust is used in the cert&mldr;?</li></ul><p>I went with the cleanest option of putting cert and key directly in <code>nvram</code>:</p><ul><li>generate certificate with <a href=https://github.com/jsha/minica>minica</a></li></ul><pre tabindex=0><code>minica -ca-cert .. -ca-key .. -domains myrouter.internal -ip-addresses 192.168.1.1
</code></pre><ul><li>ssh to router and set the <code>nvram</code> keys:</li></ul><pre tabindex=0><code>$ nvram set https_cert=&#39;-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----&#39;
$ nvram set https_key=&#39;-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----
</code></pre><ul><li>reload web UI</li></ul><pre tabindex=0><code>$ stopservice httpd
$ startservice httpd
</code></pre></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rpg.skmobi.com/tags/ddwrt>ddwrt</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/router>router</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/ssl>ssl</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/certificates>certificates</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>489 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-02-14 16:26 +0000</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/fopina/rpg/commit/8ebf6fada253463ee3b29b77e90bcd65f34eb11a target=_blank rel=noopener>8ebf6fa</a> @ 2021-02-14</p></footer></article><div class="post-nav thin"><a class=next-post href=https://rpg.skmobi.com/posts/0x6fd7_docker_internal_ca/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>0x6FD7 docker images and internal CAs</span></a>
<a class=prev-post href=https://rpg.skmobi.com/posts/0xf404_mini_delta/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>0xF404 Mono Price, Mini Print</span></a></div><div id=comments class=thin><script src=https://utteranc.es/client.js repo=fopina/rpg issue-term=title theme=github-light crossorigin=anonymous label=comment async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://rpg.skmobi.com>Filipe Pina</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://rpg.skmobi.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://rpg.skmobi.com/js/bundle.min.5a42c67b729ee2fa1059251688235399704707e04edb4e28c42c6f6dfa49d1d9.js integrity="sha256-WkLGe3Ke4voQWSUWiCNTmXBHB+BO204oxCxvbfpJ0dk=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FRYVGQ292Q"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FRYVGQ292Q",{anonymize_ip:!1})}</script></body></html>