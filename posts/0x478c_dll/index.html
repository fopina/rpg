<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="0x478C Dynamic Loose Learning (DLL)"><meta itemprop=description content="I was looking for some excuse to improve my nil little experience with IDA and building a CLI for Vasco Digipass came up in a conversation.
While keeping the OTP generator in the same machine where you use the OTP itself is unlikely to be endorsed by the security team, Vasco already provides that with Digipass For Windows (even if EOL is April 2022).
Challenge accepted, took a set of valid credentials1, the installer2 and fired up a brand new IDA VM."><meta itemprop=datePublished content="2021-11-01T23:55:50+01:00"><meta itemprop=dateModified content="2021-11-02T12:00:22+00:00"><meta itemprop=wordCount content="657"><meta itemprop=keywords content="ida,re,random,dll,"><meta property="og:title" content="0x478C Dynamic Loose Learning (DLL)"><meta property="og:description" content="I was looking for some excuse to improve my nil little experience with IDA and building a CLI for Vasco Digipass came up in a conversation.
While keeping the OTP generator in the same machine where you use the OTP itself is unlikely to be endorsed by the security team, Vasco already provides that with Digipass For Windows (even if EOL is April 2022).
Challenge accepted, took a set of valid credentials1, the installer2 and fired up a brand new IDA VM."><meta property="og:type" content="article"><meta property="og:url" content="https://rpg.skmobi.com/posts/0x478c_dll/"><meta property="article:published_time" content="2021-11-01T23:55:50+01:00"><meta property="article:modified_time" content="2021-11-02T12:00:22+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0x478C Dynamic Loose Learning (DLL)"><meta name=twitter:description content="I was looking for some excuse to improve my nil little experience with IDA and building a CLI for Vasco Digipass came up in a conversation.
While keeping the OTP generator in the same machine where you use the OTP itself is unlikely to be endorsed by the security team, Vasco already provides that with Digipass For Windows (even if EOL is April 2022).
Challenge accepted, took a set of valid credentials1, the installer2 and fired up a brand new IDA VM."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>0x478C Dynamic Loose Learning (DLL)</title><link rel=stylesheet href=https://rpg.skmobi.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><link rel=stylesheet href=https://rpg.skmobi.com/css/foo.css></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://rpg.skmobi.com>Random Post Generator</a></div><nav class="site-nav hide-in-mobile"><a href=https://rpg.skmobi.com/posts/>Posts</a>
<a href=https://rpg.skmobi.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/skboy target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/fopina target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://rpg.skmobi.com/posts/>Posts</a></li><li><a href=https://rpg.skmobi.com/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Nov 1, 2021 - 4 min read</span></div><h1>0x478C Dynamic Loose Learning (DLL)</h1></header><div class=content><p>I was looking for some excuse to improve my <del>nil</del> <em>little</em> experience with IDA and building a CLI for <a href=https://www.onespan.com/support/security/product-life-cycle>Vasco Digipass</a> came up in a conversation.</p><p>While keeping the OTP generator in the same machine where you use the OTP itself is unlikely to be endorsed by the security team, Vasco already provides that with <code>Digipass For Windows</code> (even if EOL is April 2022).</p><p>Challenge accepted, took a set of valid credentials<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, the installer<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> and fired up a brand new IDA VM.</p><h2 id=dll>DLL<a href=#dll class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>While I expected to start a long session of spamming F5 hoping IDA would give me pseudo-code easy enough to decipher, looking at the files in Digipass folder there was a <code>DP4CAPI.dll</code></p><p><img src=shot1.png alt=dll></p><p>Let&rsquo;s load that DLL in IDA and check the exports</p><p><img src=shot2.png alt=exports></p><p>Interesting export names, let&rsquo;s see how they&rsquo;re used:</p><ul><li>Add a breakpoint on each of them: right click, add breakpoint</li><li>Launch <code>DP4Windows.exe</code> from IDA: <code>Debugger</code> > <code>Process Options</code> and set <code>Application</code> to <code>DP4Windows.exe</code></li></ul><p><img src=shot3.png alt=setup></p><p>First prompt we get from the app is Profile URL with a default of <a href=http://sc.vasco.com/update/dp4windows/50/digipass.xml>http://sc.vasco.com/update/dp4windows/50/digipass.xml</a>. Back to this one later.</p><p>Next one prompts for serial and activation and entering these brings us to the first breakpoint:</p><p><img src=shot4.png alt=activate></p><p><code>*Activate</code>, makes sense. Thank you IDA for such a clear breakdown of the args as well!</p><p>8 args. Let&rsquo;s dump data for the last 8 items pushed to the stack (or 9 but skip the last as that&rsquo;s the ret address for the call)</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>Python</span><span class=o>&gt;</span> <span class=n>arg_addrs</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>idaapi</span><span class=o>.</span><span class=n>get_dword</span><span class=p>(</span><span class=n>idautils</span><span class=o>.</span><span class=n>cpu</span><span class=o>.</span><span class=n>esp</span><span class=o>+</span><span class=n>X</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>9</span><span class=p>)</span>
<span class=p>]</span>
<span class=n>Python</span><span class=o>&gt;</span> <span class=n>init_vals</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>ida_bytes</span><span class=o>.</span><span class=n>get_bytes</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=n>arg_addrs</span>
<span class=p>]</span>

<span class=n>Python</span><span class=o>&gt;</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>init_vals</span> <span class=p>:</span> <span class=k>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>

<span class=sa>b</span><span class=s1>&#39;3806564553AEF4E69858FB1FA8165D51F7EA40293792D20F06&#39;</span>
<span class=sa>b</span><span class=s1>&#39;*SERIAL</span><span class=se>\x00</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;**********ACTIVATION</span><span class=se>\x00</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xff\xff</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;111111</span><span class=se>\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xff\xff</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
</code></pre></div><p>Using the variable names assigned by IDA:</p><ul><li><code>Src</code>: back to that <a href=http://sc.vasco.com/update/dp4windows/50/digipass.xml>xml</a> from the start, this matches the <code>OfflineActivation</code> <code>StaticVector</code> value (confirmed by looking into a few more bytes)</li><li><code>a2</code>: serial number used (redacted)</li><li><code>a3</code>: activation code (redacted)</li><li><code>a4</code>: value in stack is 0</li><li><code>a5</code>: seems like a fixed value of <code>111111</code> (even with different credentials<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>)</li><li><code>a6</code>: value in stack is 0</li><li><code>a7</code>: output buffer?</li><li><code>a8</code>: output buffer?</li></ul><p>Double click on current ESP value takes us to the return of the function, so we can add a breakpoint there (press <code>C</code> to convert to code if not decompiled).<br>Then continue execution until it stops there. It does through other functions in the DLL but those were called by <code>*Activate</code>, not by the GUI.</p><p>If we look at the values of the args now (re-using the addresses we saved)</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=p>[</span>
  <span class=n>ida_bytes</span><span class=o>.</span><span class=n>get_bytes</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=n>arg_addrs</span>
<span class=p>]</span>
</code></pre></div><p>We can confirm <code>a7</code> and <code>a8</code> have been changed and I&rsquo;ll call them <code>ACTIVATION_KEY1</code> and <code>ACTIVATION_KEY2</code>. <code>EAX</code> value is <code>0</code>, that should be the expected success return code.</p><p>Click continue and next stop: <code>*validPWD</code></p><p><img src=shot5.png alt=validpwd></p><p>4 args, do the same:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>Python</span><span class=o>&gt;</span> <span class=n>arg_addrs</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>idaapi</span><span class=o>.</span><span class=n>get_dword</span><span class=p>(</span><span class=n>idautils</span><span class=o>.</span><span class=n>cpu</span><span class=o>.</span><span class=n>esp</span><span class=o>+</span><span class=n>X</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
<span class=p>]</span>
<span class=n>Python</span><span class=o>&gt;</span> <span class=n>init_vals</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>ida_bytes</span><span class=o>.</span><span class=n>get_bytes</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=n>arg_addrs</span>
<span class=p>]</span>

<span class=n>Python</span><span class=o>&gt;</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>init_vals</span> <span class=p>:</span> <span class=k>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>

<span class=sa>b</span><span class=s1>&#39;***ACTIVATION_KEY1&#39;</span>
<span class=sa>b</span><span class=s2>&#34;***ACTIVATION_KEY2&#34;</span>
<span class=sa>b</span><span class=s1>&#39;111111</span><span class=se>\x00</span><span class=s1>\...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
</code></pre></div><p>Last argument (at least) looks like output buffer. Again, break on return address, continue, dump.</p><p>Content did change, let&rsquo;s call it <code>VALID_TOKEN</code>. <code>EAX</code> value is <code>1</code>, so that should be the expected success return code.</p><p>Next stop, <code>DP4C_GenPasswordEx</code>.</p><p><img src=shot6.png alt=genpwd></p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>Python</span><span class=o>&gt;</span> <span class=n>arg_addrs</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>idaapi</span><span class=o>.</span><span class=n>get_dword</span><span class=p>(</span><span class=n>idautils</span><span class=o>.</span><span class=n>cpu</span><span class=o>.</span><span class=n>esp</span><span class=o>+</span><span class=n>X</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
<span class=p>]</span>
<span class=n>Python</span><span class=o>&gt;</span> <span class=n>init_vals</span> <span class=o>=</span> <span class=p>[</span>
  <span class=n>ida_bytes</span><span class=o>.</span><span class=n>get_bytes</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=mi>50</span><span class=p>)</span>
  <span class=k>for</span> <span class=n>X</span> <span class=ow>in</span> <span class=n>arg_addrs</span>
<span class=p>]</span>

<span class=n>Python</span><span class=o>&gt;</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>init_vals</span> <span class=p>:</span> <span class=k>print</span><span class=p>(</span><span class=n>l</span><span class=p>)</span>
<span class=sa>b</span><span class=s1>&#39;***ACTIVATION_KEY1&#39;</span>
<span class=sa>b</span><span class=s2>&#34;***ACTIVATION_KEY2&#34;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xff\xff\xff</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;***VALID_TOKEN&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xff\xff\xff\xff</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
<span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x00\x00\x00</span><span class=s1>...&#39;</span>
</code></pre></div><p>args 3 and 5 have value 0 and last two arguments look like output buffers. Break on ret, continue, dump.</p><p><code>EAX</code> value is <code>0</code>, last argument was not changed (used only for errors?) but the one before has a six-digit OTP 🏆</p><p>I&rsquo;ve put this all to use in <a href=https://github.com/fopina/dp4cli/tree/dllversion>dp4cli</a></p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>➜ dp4cli
<span class=m>120954</span>
</code></pre></div><p>Next step will be to spam F5 on all these DLL functions, but it was an interesting first step (for me)!</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>serial number and activation code <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>even if distribution is restricted, it can be found online <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rpg.skmobi.com/tags/ida>ida</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/re>re</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/random>random</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/dll>dll</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>657 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-11-01 22:55 +0000</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/fopina/rpg/commit/ce2681b413319591bf3cb41c6f1c6f22f9e98bfc target=_blank rel=noopener>ce2681b</a> @ 2021-11-02</p></footer></article><div class="post-nav thin"><a class=prev-post href=https://rpg.skmobi.com/posts/0x904d_cloudflare_pull/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>0x904Drop IPTables Drop</span></a></div><div id=comments class=thin><script src=https://utteranc.es/client.js repo=fopina/rpg issue-term=title theme=github-light crossorigin=anonymous label=comment async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2021 <a href=https://rpg.skmobi.com>Filipe Pina</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://rpg.skmobi.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://rpg.skmobi.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-152680315-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>