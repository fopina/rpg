<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="0x6FD7 docker images and internal CAs"><meta itemprop=description content="I use an internal CA for all the services in my home lab.
Big part of the lab is running on docker swarm.
Usually services connect through internal networks (without using HTTPS as that is offloaded to traefik), but sometimes they do need to validate the certificates (such as interacting with the NAS or router APIs).
For personal images, private CA is naturally bundled into them.
For public, 3rd party, ones, I usually rebuild them only for that purpose, such as:"><meta itemprop=datePublished content="2021-02-15T01:13:47+00:00"><meta itemprop=dateModified content="2021-02-15T00:06:34+00:00"><meta itemprop=wordCount content="177"><meta itemprop=keywords content="docker,containers,certificates,"><meta property="og:title" content="0x6FD7 docker images and internal CAs"><meta property="og:description" content="I use an internal CA for all the services in my home lab.
Big part of the lab is running on docker swarm.
Usually services connect through internal networks (without using HTTPS as that is offloaded to traefik), but sometimes they do need to validate the certificates (such as interacting with the NAS or router APIs).
For personal images, private CA is naturally bundled into them.
For public, 3rd party, ones, I usually rebuild them only for that purpose, such as:"><meta property="og:type" content="article"><meta property="og:url" content="https://rpg.skmobi.com/posts/0x6fd7_docker_internal_ca/"><meta property="article:published_time" content="2021-02-15T01:13:47+00:00"><meta property="article:modified_time" content="2021-02-15T00:06:34+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="0x6FD7 docker images and internal CAs"><meta name=twitter:description content="I use an internal CA for all the services in my home lab.
Big part of the lab is running on docker swarm.
Usually services connect through internal networks (without using HTTPS as that is offloaded to traefik), but sometimes they do need to validate the certificates (such as interacting with the NAS or router APIs).
For personal images, private CA is naturally bundled into them.
For public, 3rd party, ones, I usually rebuild them only for that purpose, such as:"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>0x6FD7 docker images and internal CAs</title><link rel=stylesheet href=https://rpg.skmobi.com/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><link rel=stylesheet href=https://rpg.skmobi.com/css/foo.css></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://rpg.skmobi.com>Random Post Generator</a></div><nav class="site-nav hide-in-mobile"><a href=https://rpg.skmobi.com/posts/>Posts</a>
<a href=https://rpg.skmobi.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/skboy target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://github.com/fopina target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://rpg.skmobi.com/posts/>Posts</a></li><li><a href=https://rpg.skmobi.com/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Feb 15, 2021 - 1 min read</span></div><h1>0x6FD7 docker images and internal CAs</h1></header><div class=content><p>I use an internal CA for all the services in my home lab.<br>Big part of the lab is running on docker swarm.<br>Usually services connect through internal networks (without using HTTPS as that is offloaded to traefik), but sometimes they do need to validate the certificates (such as interacting with the NAS or router APIs).</p><p>For personal images, private CA is naturally bundled into them.<br>For public, 3rd party, ones, I usually rebuild them only for that purpose, such as:</p><div class=highlight><pre class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=k>FROM</span><span class=s> homeassistant/home-assistant:2021.2.3</span><span class=err>
</span><span class=err>
</span><span class=err></span><span class=k>ADD</span> myCA.pem /usr/local/share/ca-certificates/myCA.crt<span class=err>
</span><span class=err></span><span class=k>RUN</span> /usr/sbin/update-ca-certificates<span class=err>
</span><span class=err></span><span class=c># for python requests lib...</span><span class=err>
</span><span class=err></span><span class=k>ENV</span> <span class=nv>REQUESTS_CA_BUNDLE</span><span class=o>=</span>/etc/ssl/certs/ca-certificates.crt<span class=err>
</span></code></pre></div><p>This means that everytime the upstream image is updated, I have to rebuild it (before re-deploy). Pain&mldr;</p><p>Much simpler option is to bind mount the host trusted certificates in the container (assuming host has the CA setup).</p><p>My raspberry Pis (the swarm cluster) have the CA installed with:</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=l>(tasks - for debian/raspbian)</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>copy my CA</span><span class=w>
</span><span class=w>  </span><span class=nt>copy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>src</span><span class=p>:</span><span class=w> </span><span class=l>myCA.pem</span><span class=w>
</span><span class=w>    </span><span class=nt>dest</span><span class=p>:</span><span class=w> </span><span class=l>/usr/local/share/ca-certificates/myCA.crt</span><span class=w>
</span><span class=w>    </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span><span class=w>    </span><span class=nt>group</span><span class=p>:</span><span class=w> </span><span class=l>root</span><span class=w>
</span><span class=w>    </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=m>0644</span><span class=w>
</span><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span><span class=w>  </span><span class=nt>notify</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>update trusted ca</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=l>(handlers)</span><span class=w>
</span><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>update trusted ca</span><span class=w>
</span><span class=w>  </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>/usr/sbin/update-ca-certificates</span><span class=w>
</span><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>True</span><span class=w>
</span></code></pre></div><p>So any containers running in these hosts can have the system trusted CAs (including internal one) bind mounted with:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>docker run -v /etc/ssl/certs/ca-certificates.crt:/etc/ssl/certs/ca-certificates.crt:ro <span class=se>\
</span><span class=se></span>           -e <span class=nv>REQUESTS_CA_BUNDLE</span><span class=o>=</span>/etc/ssl/certs/ca-certificates.crt <span class=se>\
</span><span class=se></span>           homeassistant/home-assistant:2021.2.3
</code></pre></div></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rpg.skmobi.com/tags/docker>docker</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/containers>containers</a></span><span class=tag><a href=https://rpg.skmobi.com/tags/certificates>certificates</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>177 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2021-02-15 01:13 +0000</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg><a href=https://github.com/fopina/rpg/commit/164c9711d95f41f97279e10d6c7d68f4d1db5f5e target=_blank rel=noopener>164c971</a> @ 2021-02-15</p></footer></article><div class="post-nav thin"><a class=next-post href=https://rpg.skmobi.com/posts/0x474e_telegraf/><span class=post-nav-label><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>&nbsp;Newer</span><br><span>0x474E (In)fluent(a)bit</span></a>
<a class=prev-post href=https://rpg.skmobi.com/posts/0xb752_ddwrt_ssl/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>0xB752 ddwrt + custom certificate</span></a></div><div id=comments class=thin><script src=https://utteranc.es/client.js repo=fopina/rpg issue-term=title theme=github-light crossorigin=anonymous label=comment async></script></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://rpg.skmobi.com>Filipe Pina</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://rpg.skmobi.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://rpg.skmobi.com/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-FRYVGQ292Q','auto');ga('send','pageview');}</script></body></html>